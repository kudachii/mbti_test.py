import streamlit as st
import plotly.graph_objects as go
import random

def run_mbti_diagnostic():
    # --- 1. 質問データ (24問) ---
    questions = [
        ("多人数で集まるイベントに参加すると元気が出る", "E-I", 1),
        ("自分の考えを整理するときは、誰かに話すより一人で考えたい", "E-I", -1),
        ("知らない人にも自分から話しかけるのは苦ではない", "E-I", 1),
        ("活動的な一日の後は、一人で静かに過ごす時間が必要だ", "E-I", -1),
        ("新しいアイデアより、すでに証明されているやり方を信頼する", "S-N", 1),
        ("空想より、現実的な問題解決に興味がある", "S-N", 1),
        ("物事の裏に隠された「意味」について考えるのが好きだ", "S-N", -1),
        ("詳細データより、インスピレーションを信じることが多い", "S-N", -1),
        ("決断を下す際、論理や効率を最も重視する", "T-F", 1),
        ("悩みを聞くとき、解決策を提示するよりまず気持ちに寄り添いたい", "T-F", -1),
        ("正論でも、誰かを傷つける可能性があるなら言葉を選ぶべきだ", "T-F", -1),
        ("誰かが間違っていたら、場の空気を壊してでも訂正すべきだと思う", "T-F", 1),
        ("やるべきことはリスト化して、一つずつ消していくのが好きだ", "J-P", 1),
        ("旅行に行くときは、予定を細かく決めずに動きたい", "J-P", -1),
        ("仕事や勉強は、締め切りギリギリにならないと本気が出ない", "J-P", -1),
        ("決まったルールやルーティンを守ることに安心感を覚える", "J-P", 1),
        ("注目を浴びる立場になることは、どちらかといえば好きだ", "E-I", 1),
        ("マニュアルがある場合、それを忠実に守る方だ", "S-N", 1),
        ("人から「共感力が高い」と言われるより「頭が良い」と言われたい", "T-F", 1),
        ("予期せぬトラブルにも臨機応変に対応することを楽しめる", "J-P", -1),
        ("ストレスを感じる状況でも、比較的冷静でいられる", "A-T", 1),
        ("過去の失敗をいつまでも悔やんでしまうことがある", "A-T", -1),
        ("自分の能力や決断に自信を持っている", "A-T", 1),
        ("他人の目が気になり、自分を過小評価してしまうことがある", "A-T", -1),
    ]

    # --- 2. メンターデータ ---
    mentor_data = {
        "ギャル先生": {
            "quote": "「おはよー！あんたの魅力、マジでバズり確定じゃん！✨ その調子で今日もハピネスに、自分軸でブチ上げてこー！💖」",
            "actions": ["「コンビニの新作スイーツ買って自分にご褒美あげちゃお！✨」", "「鏡の前で『今日も可愛いじゃん』って言ってみて？💖」", "「派手な色の小物を1つ身につけてみて！🌈」"]
        },
        "頼れるお姉さん": {
            "quote": "「一生懸命なところ、素敵よ。でもたまには肩の力を抜いて、私に甘えていいのよ？」",
            "actions": ["「5分だけデジタルデトックスをして温かい飲み物を。心の充電が必要よ。」", "「寝る前に頑張ったことを3つ思い出して自分を褒めてあげてね。」", "「ゆっくりお風呂に浸かって、好きな香りの入浴剤を楽しんでみて。」"]
        },
        "カサネ・イズミ：論理と不確定要素": {
            "quote": "「あなたのデータは極めて特異だ。その思考を最適化すれば、さらなる高みへ到達できる。」",
            "actions": ["「デスクの上を完全に片付けろ。視覚的なノイズを排除しろ。」", "「今日学んだことを3行でメモしろ。知識の定着こそが力だ。」", "「タスクの優先順位を見直し、重要度の低いものを1つ捨てろ。」"]
        },
        "ツンデレな指導員": {
            "quote": "「ふん、あんたみたいなタイプは私が付いてないと危なっかしいわね。しっかりしなさいよ！」",
            "actions": ["「姿勢を正しなさい！背筋を伸ばしなさい！それだけで印象が変わるんだから。」", "「たまには自分を甘やかしなさいよね。ずっと頑張りすぎなのよ…心配してないわよ！」", "「今日は10分早く寝なさい。明日寝坊して困るのはあんたなんだからね！」"]
        },
        "論理的なビジネスコーチ": {
            "quote": "「あなたの能力を最大限に活かすための戦略を練ろう。まずは現状の分析からだ。」",
            "actions": ["「今日一番の重要課題を1つ決めて、それに集中しよう。」", "「明日のスケジュールを今夜のうちに10分で見直しておこう。」", "「身の回りのものを1つだけ新調してみよう。小さな変化が刺激になる。」"]
        },
        "優しさに溢れるメンター (Default)": {
            "quote": "「あなたは今のままで十分素晴らしいですよ。一緒に、一歩ずつ進んでいきましょうね。」",
            "actions": ["「深呼吸をゆっくり3回しましょう。」", "「重要な決断は明日の朝にしましょう。」", "「散歩をしながら空を眺めてみてください。」"]
        }
    }

    # --- 3. MBTI DB (全16タイプ詳細版) ---
    # --- 3. MBTI DB (全16タイプ・全メンターメッセージ搭載版) ---
    mbti_db = {
        "ISTJ": {
            "name": "管理者", "animal": "ビーバー", "catchphrase": "「一歩ずつ、確実に。信頼を築き上げる職人」",
            "strengths": "責任感が強く、計画的でミスが少ない。誠実で約束を必ず守る。",
            "weaknesses": "変化への対応が遅く、ルールに固執しがち。他人の感情に疎い面がある。",
            "details": {"work": "手順を完璧に守る『組織の柱』", "love": "超誠実で一途な安定感", "stress": "細かいミスに固執しパニック", "best_match": "ESFJ（ゾウ）"},
            "messages": {
                "ギャル先生": "ビーバーちゃん、マジメすぎ！たまには羽目外してアゲてこ！✨",
                "頼れるお姉さん": "ビーバーさん、いつも完璧ね。でも私の前では息を抜いていいのよ？",
                "カサネ・イズミ：論理と不確定要素": "ビーバー。君の規律正しさは評価に値する。その整合性を維持したまえ。",
                "ツンデレな指導員": "ちょっとビーバー！あんたまた一人で抱え込んでんじゃないわよ！",
                "論理的なビジネスコーチ": "ビーバーさん、その誠実さは武器です。次は効率を最適化しましょう。",
                "優しさに溢れるメンター (Default)": "ビーバーさん、一歩ずつ進むあなたの姿はとても美しいですよ。"
            }
        },
        "ISFJ": {
            "name": "擁護者", "animal": "シカ", "catchphrase": "「静かな優しさで、みんなの心に灯をともす」",
            "strengths": "献身的で、細かい配慮ができる。実務能力が高く、誰からも信頼される。",
            "weaknesses": "自分を後回しにしやすく、不満を溜め込む。変化を過剰に恐れる。",
            "details": {"work": "先回りして支える『最高のサポーター』", "love": "献身的な愛と深い思いやり", "stress": "『自分は不要』と過剰に悲観", "best_match": "ESTJ（番犬）"},
            "messages": {
                "ギャル先生": "シカちゃん、優しさ神！今日は自分を一番可愛がってあげて！💖",
                "頼れるお姉さん": "シカさん、無理して笑ってない？たまには私に甘えてちょうだい。",
                "カサネ・イズミ：論理と不確定要素": "シカ。君の献身は集団の安定に寄与している。だが自己犠牲は非効率だ。",
                "ツンデレな指導員": "シカ！あんた、お人好しもいい加減にしなさいよね！心配なんだから！",
                "論理的なビジネスコーチ": "シカさん、周囲への配慮を成果に結びつける方法を考えましょう。",
                "優しさに溢れるメンター (Default)": "シカさん、あなたの穏やかさがみんなを救っていますよ。"
            }
        },
        "INFJ": {
            "name": "提唱者", "animal": "フクロウ", "catchphrase": "「夜の静寂の中で、未来の光を見通す賢者」",
            "strengths": "洞察力に優れ、他人の深層心理を理解する。理想に向かって静かに突き進む。",
            "weaknesses": "理想が高すぎて現実とのギャップに苦しむ。完璧主義でストレスを抱えやすい。",
            "details": {"work": "本質を見抜く『静かなリーダー』", "love": "精神的な深い繋がりを重視", "stress": "感覚過敏になり引きこもる", "best_match": "ENFJ（ライオン）"},
            "messages": {
                "ギャル先生": "フクロウちゃん、世界観エグい！その感性マジで尊いよ！🌈",
                "頼れるお姉さん": "フクロウさん、深い悩みがあるならいつでも聞くわ。独りで抱えないで。",
                "カサネ・イズミ：論理と不確定要素": "フクロウ。君の洞察は興味深い。その直感を数式化したいものだ。",
                "ツンデレな指導員": "フクロウ！考えすぎよ！たまにはバカになって走りなさいよ！",
                "論理的なビジネスコーチ": "フクロウさん、そのビジョンを具体的な戦略に落とし込みましょう。",
                "優しさに溢れるメンター (Default)": "フクロウさん、あなたの理想がいつか形になるよう支えますね。"
            }
        },
        "INTJ": {
            "name": "建築家", "animal": "トラ", "catchphrase": "「誰にも媚びず、己の知略で世界を再構築する」",
            "strengths": "圧倒的な戦略思考と分析力。独立心が強く、自力で道を切り拓く。",
            "weaknesses": "自信過剰に見られやすく、批判に容赦ない。感情的な交流を軽視しがち。",
            "details": {"work": "長期戦略を立てる『孤高の軍師』", "love": "知的な刺激と信頼を重視", "stress": "ジャンクな刺激に依存し現実逃避", "best_match": "ENTP（キツネ）"},
            "messages": {
                "ギャル先生": "トラさん、クールすぎ！その最強頭脳で世界回しちゃお！🔥",
                "頼れるお姉さん": "トラさん、強がらなくていいのよ。あなたの弱さも、私は知ってるわ。",
                "カサネ・イズミ：論理と不確定要素": "トラ。同類よ、君の論理に不確定要素はない。完璧な計画を完遂しろ。",
                "ツンデレな指導員": "トラ！あんたの理屈は正しいけど、たまには可愛げを見せなさいよ！",
                "論理的なビジネスコーチ": "トラさん、あなたの知略は唯一無二です。市場を支配しに行きましょう。",
                "優しさに溢れるメンター (Default)": "トラさん、あなたの歩む道は険しいかもしれませんが、応援しています。"
            }
        },
        "ISTP": {
            "name": "巨匠", "animal": "サメ", "catchphrase": "「乱世をクールに泳ぎ、一瞬の好機を逃さない」",
            "strengths": "観察眼が鋭く、道具や技術の習得が早い。冷静沈着でトラブルに強い。",
            "weaknesses": "飽きっぽく、ルーチンワークを嫌う。感情を出すのが極端に苦手で誤解されやすい。",
            "details": {"work": "即断即決の『トラブルシューター』", "love": "自由を尊重する付かず離れずの関係", "stress": "感情が制御不能になり爆発", "best_match": "ESTP（チーター）"},
            "messages": {
                "ギャル先生": "サメちゃん、自由で最高！そのセンス、マジで神ってる！✨",
                "頼れるお姉さん": "サメさん、一人の時間もいいけど、たまには私と遊んでくれない？",
                "カサネ・イズミ：論理と不確定要素": "サメ。実地での解決能力は賞賛に値する。無駄のない動きだ。",
                "ツンデレな指導員": "サメ！あんた、また勝手なことして！…まあ、結果は出してるけどさ！",
                "論理的なビジネスコーチ": "サメさん、その職人技を仕組み化できれば、さらにスケールできますよ。",
                "優しさに溢れるメンター (Default)": "サメさん、あなたの自由な精神が新しい道を作るのでしょうね。"
            }
        },
        "ISFP": {
            "name": "冒険家", "animal": "ネコ", "catchphrase": "「自分の『好き』を呼吸するように生きる芸術家」",
            "strengths": "感性が豊かで芸術的センスがある。今この瞬間を大切にし、他人に寛容。",
            "weaknesses": "計画性がなく、決断を先延ばしにする。批判を受けると激しく落ち込む。",
            "details": {"work": "感性で世界を彩る『表現者』", "love": "言葉より雰囲気で示す愛情", "stress": "自信を喪失し殻に閉じこもる", "best_match": "ESFP（レッサーパンダ）"},
            "messages": {
                "ギャル先生": "ネコちゃん、感性ヤバすぎ！自分信じて突き進んじゃえ！🐾",
                "頼れるお姉さん": "ネコさん、あなたの作るものはとても優しいわ。自信を持って。",
                "カサネ・イズミ：論理と不確定要素": "ネコ。君の非言語的な表現は、私の論理では測れない価値がある。",
                "ツンデレな指導員": "ネコ！あんた、フラフラしてると危なっかしいわよ！こっち来なさい！",
                "論理的なビジネスコーチ": "ネコさん、感性を活かしつつ、継続的な発信プランを立てましょう。",
                "優しさに溢れるメンター (Default)": "ネコさん、あなたの美しい心が、周りを癒しているのですよ。"
            }
        },
        "INFP": {
            "name": "仲介者", "animal": "ウサギ", "catchphrase": "「傷つくことを恐れず、愛と優しさを信じ続ける」",
            "strengths": "深い共感力と独自の価値観を持つ。クリエイティブで、精神的な理想を追求する。",
            "weaknesses": "繊細すぎて傷つきやすい。現実的な問題や細かい数字の管理が苦手。",
            "details": {"work": "魂が震える価値を追う『夢想家』", "love": "ロマンチックで純粋な深い愛", "stress": "急に理詰めになり攻撃的に変貌", "best_match": "ENFP（カワウソ）"},
            "messages": {
                "ギャル先生": "ウサギちゃん、優しさ神！そのピュアさ、絶対守りたいんだけど！🐰",
                "頼れるお姉さん": "ウサギさん、世界は時々厳しいけど、あなたの居場所はここにあるわ。",
                "カサネ・イズミ：論理と不確定要素": "ウサギ。君の感情論は興味深いデータだ。分析に協力してくれないか？",
                "ツンデレな指導員": "ウサギ！あんた、泣いてる暇があったら前向きなさいよね！",
                "論理的なビジネスコーチ": "ウサギさん、理想を現実にするための小さなステップを決めましょう。",
                "優しさに溢れるメンター (Default)": "ウサギさん、あなたの優しい夢が、いつか世界を救うかもしれません。"
            }
        },
        "INTP": {
            "name": "論理学者", "animal": "チンパンジー", "catchphrase": "「常識を疑い、知の迷宮を楽しむ知的な探検家」",
            "strengths": "論理的な矛盾を即座に見抜く。独創的な発想と、膨大な知識量を持つ。",
            "weaknesses": "実行力に欠け、考えるだけで終わりがち。他人の感情的な訴えを無視しやすい。",
            "details": {"work": "複雑な仕組みを解明する『分析官』", "love": "知的な会話と分析を通じた愛", "stress": "感情が溢れてコントロール不能に", "best_match": "ENTJ（ワシ）"},
            "messages": {
                "ギャル先生": "パンジーくん、天才すぎ！その発想、バズり確定じゃん！🚀",
                "頼れるお姉さん": "パンジーさん、難しい顔してどうしたの？私には本音を見せて？",
                "カサネ・イズミ：論理と不確定要素": "チンパンジー。君の知的好奇心は私に近い。共に真理を探究しよう。",
                "ツンデレな指導員": "パンジー！あんた理屈ばっかり！少しは体を動かしなさいよ！",
                "論理的なビジネスコーチ": "パンジーさん、その分析をビジネスモデルへ転換する好機です。",
                "優しさに溢れるメンター (Default)": "パンジーさん、あなたの深い思考が、真実を照らし出すでしょう。"
            }
        },
        "ESTP": {
            "name": "起業家", "animal": "チーター", "catchphrase": "「考える前に跳べ。直感とスピードで世界を制す」",
            "strengths": "行動力が抜群で、チャンスを逃さない。変化に強く、周囲を巻き込む力がある。",
            "weaknesses": "リスクを軽視しすぎる。長期的な計画を立てるのが苦手で、飽きっぽい。",
            "details": {"work": "現場を即決で動かす『実務家』", "love": "スリルと楽しさを共有する関係", "stress": "無謀な暴走で周囲を混乱させる", "best_match": "ISTP（サメ）"},
            "messages": {
                "ギャル先生": "チーターくん、爆速すぎ！ブチ上げて最高な景色見に行こ！🐆✨",
                "頼れるお姉さん": "チーターさん、たまには立ち止まって私と一緒に景色を見ない？",
                "カサネ・イズミ：論理と不確定要素": "チーター。君の即時実行力は不確定要素を排除する。悪くない速度だ。",
                "ツンデレな指導員": "チーター！あんた、少しは後先考えなさいよ！危なっかしいわね！",
                "論理的なビジネスコーチ": "チーターさん、その突破力は凄まじい。次はリスク管理を強化しましょう。",
                "優しさに溢れるメンター (Default)": "チーターさん、あなたの勇気がみんなに活力を与えていますよ。"
            }
        },
        "ESFP": {
            "name": "エンターテイナー", "animal": "レッサーパンダ", "catchphrase": "「一瞬で場を彩る、愛されキャラの天才」",
            "strengths": "社交的で楽観的。人を喜ばせる天才で、どんな場も盛り上げることができる。",
            "weaknesses": "衝動的で、先のことを考えない。深い議論や真面目な雰囲気が苦手。",
            "details": {"work": "場を明るくする『ムードメーカー』", "love": "今を全力で楽しむサプライズ愛", "stress": "孤独感から被害妄想が激化", "best_match": "ISFP（ネコ）"},
            "messages": {
                "ギャル先生": "パンダちゃん、最高にハッピー！アゲてこ！マジで主役じゃん！🐼💖",
                "頼れるお姉さん": "パンダさん、いつも元気をくれてありがとう。疲れたら私の肩で休んでね。",
                "カサネ・イズミ：論理と不確定要素": "レッサーパンダ. 君の存在は統計的に場のエントロピーを増大させる。愉快だ。",
                "ツンデレな指導員": "パンダ！あんた、調子に乗って失敗しても知らないからね！…応援してるけど。",
                "論理的なビジネスコーチ": "パンダさん、あなたの対人魅力は最大の資産です。ブランディングしましょう。",
                "優しさに溢れるメンター (Default)": "パンダさん、あなたの笑顔がみんなの幸せに繋がっているのですよ。"
            }
        },
        "ENFP": {
            "name": "広報運動家", "animal": "カワウソ", "catchphrase": "「無限のワクワクを撒き散らす、愛の伝道師」",
            "strengths": "創造性と情熱に溢れる。人の強みを見抜いて応援し、新しい風を呼び込む。",
            "weaknesses": "注意力が散漫で、何事も中途半端になりがち。他人の評価を気にしすぎて疲弊する。",
            "details": {"work": "アイデアを形にする『クリエイター』", "love": "運命を信じ全力で応援する愛", "stress": "強迫観念に囚われガチガチになる", "best_match": "INFP（ウサギ）"},
            "messages": {
                "ギャル先生": "カワウソちゃん、ワクワク全開！冒険しよ！人生楽しんだもん勝ち！🦦",
                "頼れるお姉さん": "カワウソさん、あなたの夢物語、私は大好きよ。もっと聞かせて？",
                "カサネ・イズミ：論理と不確定要素": "カワウソ。君の不規則な発想は、計算を超えた可能性を秘めている。",
                "ツンデレな指導員": "カワウソ！あんたの夢を笑う奴は私がぶっ飛ばしてあげるから！",
                "論理的なビジネスコーチ": "カワウソさん、そのアイデアを形にする実行部隊を組織しましょう。",
                "優しさに溢れるメンター (Default)": "カワウソさん、あなたの明るい未来が現実になるよう祈っています。"
            }
        },
        "ENTP": {
            "name": "討論者", "animal": "キツネ", "catchphrase": "「知的なイタズラで、退屈な世界に風穴を開ける」",
            "strengths": "頭の回転が異常に速く、弁が立つ。難解な問題をパズル感覚で楽しんで解決する。",
            "weaknesses": "議論好きが過ぎて敵を作りやすい。実行よりも計画や議論自体を楽しんでしまう。",
            "details": {"work": "常識を疑う『イノベーター』", "love": "知的な駆け引きと刺激を好む", "stress": "偏屈な理屈をこねて正当化", "best_match": "INTJ（トラ）"},
            "messages": {
                "ギャル先生": "キツネくん、天才！常識ブチ壊して新しいことしちゃお！🦊🔥",
                "頼れるお姉さん": "キツネさん、憎まれ口ばかり叩かないで、少しは可愛く甘えたら？",
                "カサネ・イズミ：論理と不確定要素": "キツネ。君の議論は刺激的だ。私の仮説を論破してみたまえ。",
                "ツンデレな指導員": "キツネ！あんたの理屈は聞き飽きたわよ！もっと本音を言いなさい！",
                "論理的なビジネスコーチ": "キツネさん、その破壊的アイデアを収益化するフレームワークを考えましょう。",
                "優しさに溢れるメンター (Default)": "キツネさん、あなたの独創的な視点が、世界を変えるきっかけになるでしょう。"
            }
        },
        "ESTJ": {
            "name": "幹部", "animal": "番犬", "catchphrase": "「揺るぎない正義感で、秩序と平和を守り抜く」",
            "strengths": "組織の管理能力が非常に高く、実利的。明確な基準を持って正しく行動する。",
            "weaknesses": "頑固で自分の意見を曲げない。他人の感情的な事情を無視してしまいがち。",
            "details": {"work": "組織をまとめる『完璧なリーダー』", "love": "将来を見据えた堅実な付き合い", "stress": "孤独感から周囲に当たり散らす", "best_match": "ISFJ（シカ）"},
            "messages": {
                "ギャル先生": "ワンちゃん、リーダーシップマジリスペクト！頼りにしてるよ！🐕",
                "頼れるお姉さん": "番犬さん、いつもみんなを守ってくれてありがとう。お疲れ様。",
                "カサネ・イズミ：論理と不確定要素": "番犬. 君の統率力はシステムの効率を最大化する。そのまま続けろ。",
                "ツンデレな指導員": "番犬！あんた、たまにはリーダーの仮面を脱いで休みさないわよ！",
                "論理的なビジネスコーチ": "番犬さん、更なる組織拡大のための人事戦略を策定しましょう。",
                "優しさに溢れるメンター (Default)": "番犬さん、あなたの誠実な働きが、みんなの安心を支えていますよ。"
            }
        },
        "ESFJ": {
            "name": "領事", "animal": "ゾウ", "catchphrase": "「大きな愛でみんなを包む、コミュニティの守護神」",
            "strengths": "社交的で世話好き、コミュニティを支える力がある。責任感が強く、伝統を大切にする。",
            "weaknesses": "他人の評価に非常に敏感で、批判に弱い。お節介が過ぎて煙たがられることも。",
            "details": {"work": "調和を重んじる『守護者』", "love": "家庭的で安定感抜群の尽くす愛", "stress": "理屈っぽい批判に弱く過激化", "best_match": "ISTJ（ビーバー）"},
            "messages": {
                "ギャル先生": "ゾウさん、優しさMAX！いつもありがト！マジで女神じゃん！🐘💖",
                "頼れるお姉さん": "ゾウさん、他人のことばかりじゃなくて、自分の幸せも考えていいのよ？",
                "カサネ・イズミ：論理と不確定要素": "ゾウ. 君の社会的調和能力は、個の集合体を組織に変える。重要だ。",
                "ツンデレな指導員": "ゾウ！あんた、いい子ぶってストレス溜めるのは禁止よ！わかった！？",
                "論理的なビジネスコーチ": "ゾウさん、あなたのネットワークをビジネス資産として活用しましょう。",
                "優しさに溢れるメンター (Default)": "ゾウさん、あなたの温かな手が、多くの人を救っているのですよ。"
            }
        },
        "ENFJ": {
            "name": "主人公", "animal": "ライオン", "catchphrase": "「みんなの可能性を信じ、光差す方へ導く太陽」",
            "strengths": "カリスマ性があり、他人の成長を支援するのが得意。共感力が高く、理想社会を目指す。",
            "weaknesses": "他人を助けることに執着しすぎて自分を失う。拒絶されると立ち直るのが遅い。",
            "details": {"work": "カリスマ性で人を導く『火付け役』", "love": "理想のパートナーシップを追求", "stress": "自信を喪失し周囲の目を過剰に気にする", "best_match": "INFJ（フクロウ）"},
            "messages": {
                "ギャル先生": "ライオンくん、情熱ヤバい！あんたについてけば間違いなし！🦁✨",
                "頼れるお姉さん": "ライオンさん、あなたは太陽みたい。でも夜は私の側で静かに過ごして？",
                "カサネ・イズミ：論理と不確定要素": "ライオン. 君のカリスマ性は論理を超越して人を動かす。研究対象だ。",
                "ツンデレな指導員": "ライオン！あんた、一人で全部背負おうとしないで、私を頼りなさいよ！",
                "論理的なビジネスコーチ": "ライオンさん、その影響力を最大化し、社会変革をリードしましょう。",
                "優しさに溢れるメンター (Default)": "ライオンさん、あなたの光が、多くの人の希望となっているのですよ。"
            }
        },
        "ENTJ": {
            "name": "指揮官", "animal": "ワシ", "catchphrase": "「高みから未来を見据え、勝利への最短距離を飛ぶ」",
            "strengths": "圧倒的なリーダーシップと決断力。論理的で効率的、高い壁ほど燃えるタイプ。",
            "weaknesses": "威圧的になりやすく、他人の感情を無視する。忍耐に欠け、遅いペースを許せない。",
            "details": {"work": "圧倒的な決断力の『指揮官』", "love": "切磋琢磨し合える対等な関係", "stress": "情緒不安定になり些細な事で怒鳴る", "best_match": "INTP（チンパンジー）"},
            "messages": {
                "ギャル先生": "ワシさん、最強リーダー！世界征服とかマジでいけそうじゃん！🦅🔥",
                "頼れるお姉さん": "ワシさん、仕事の話は終わり。今は私だけを見てくれないかしら？",
                "カサネ・イズミ：論理と不確定要素": "ワシ. 君の意思決定の速度は合理的だ。不純物を排除し勝利しろ。",
                "ツンデレな指導員": "ワシ！あんたの命令口調はムカつくけど、実力だけは認めてあげるわよ！",
                "論理的なビジネスコーチ": "ワシさん、あなたのビジョンは完璧です。次は持続可能な組織構造を。",
                "優しさに溢れるメンター (Default)": "ワシさん、あなたの強い志が、新しい時代を切り拓くのでしょう。"
            }
        }
    }

    # --- 4. セッション状態の管理 ---
    if "show_result" not in st.session_state:
        st.session_state["show_result"] = False
    if "run_count" not in st.session_state:
        st.session_state["run_count"] = 0

    # --- 5. 画面表示 ---
    if not st.session_state["show_result"]:
        st.title("性格診断クエスト 🐾")
        
        answered_count = 0
        for i in range(len(questions)):
            if f"q_{i}_{st.session_state['run_count']}" in st.session_state:
                answered_count += 1
        
        with st.sidebar:
            st.header("📊 診断の進捗")
            progress = answered_count / len(questions)
            st.progress(progress)
            st.write(f"**{answered_count} / {len(questions)} 問** 回答済み")
            st.divider()
            st.markdown("**ギャル先生からの応援**")
            if progress < 0.5: st.write("「まずは直感でポチポチいこー！✨」")
            elif progress < 1.0: st.write("「いい感じ！半分超えたよ！🔥」")
            else: st.write("「完璧！あんたマジ最高！💖」")

        with st.container():
            for i, (q_text, axis, weight) in enumerate(questions):
                st.markdown(f"**Q{i+1}. {q_text}**")
                st.radio(
                    f"radio_{i}", options=[1, 2, 3, 4, 5],
                    format_func=lambda x: {1: "全く違う", 2: "違う", 3: "中立", 4: "そう思う", 5: "強くそう思う"}[x],
                    key=f"q_{i}_{st.session_state['run_count']}", 
                    label_visibility="collapsed", horizontal=True, index=2
                )
                st.write("---")

        if st.button("診断結果を詳しく見る ✨", use_container_width=True):
            if answered_count < len(questions):
                st.error(f"まだ回答していない質問があるよ！（残り {len(questions) - answered_count} 問）")
            else:
                st.session_state["show_result"] = True
                st.rerun()

    else:
        st.balloons()
        scores = {"E-I": 0, "S-N": 0, "T-F": 0, "J-P": 0, "A-T": 0}
        for i, (_, axis, weight) in enumerate(questions):
            val = st.session_state.get(f"q_{i}_{st.session_state['run_count']}", 3)
            scores[axis] += (val - 3) * weight

        m_core = ("E" if scores["E-I"] >= 0 else "I") + ("S" if scores["S-N"] >= 0 else "N") + \
                 ("T" if scores["T-F"] >= 0 else "F") + ("J" if scores["J-P"] >= 0 else "P")
        full_res = m_core + ("-A" if scores["A-T"] >= 0 else "-T")
        detail = mbti_db.get(m_core, mbti_db["ISTJ"])

        st.markdown(f"## 判定結果：{full_res}")
        st.markdown(f"### あなたを動物に例えると… 『 {detail['animal']} 』")
        st.info(f"**{detail['catchphrase']}**")

        # 1. タブの項目に「📊 強みと弱み」を追加
        tab1, tab2, tab3, tab4, tab5 = st.tabs(["📊 強みと弱み", "💼 仕事", "💖 恋愛", "💀 ストレス", "🤝 相性"])

        # 2. 最初のタブ（tab1）に強みと弱みを出す
        with tab1:
            st.markdown(f"✅ **強み**: {detail['strengths']}")
            st.markdown(f"⚠️ **弱み**: {detail['weaknesses']}")
        
        # 3. 残りのタブをずらして表示（既存のものを入れる）
        with tab2: st.write(detail['details']['work'])
        with tab3: st.write(detail['details']['love'])
        with tab4: st.warning(detail['details']['stress'])
        with tab5: st.info(f"最高の相性：{detail['details']['best_match']}")
            
        st.divider()
        categories = ['外向(E)', '感覚(S)', '思考(T)', '判断(J)', '自己主張(A)']
        values = [scores["E-I"], scores["S-N"], scores["T-F"], scores["J-P"], scores["A-T"]]
        fig = go.Figure(data=go.Scatterpolar(r=values + [values[0]], theta=categories + [categories[0]], fill='toself'))
        fig.update_layout(polar=dict(radialaxis=dict(visible=True, range=[-12, 12])), showlegend=False)
        st.plotly_chart(fig, use_container_width=True)

        st.markdown("### 🤝 今日のメンターを指名")
        selected_mentor = st.selectbox("指名する", options=list(mentor_data.keys()), index=0)
        
        # ★ ここがポイント！DBから選ばれたメンターのセリフを直接取得 ★
        msg = detail["messages"].get(selected_mentor, "こんにちは、応援していますよ！")
        
        st.chat_message("assistant").write(f"**{selected_mentor}**：「{msg}」")
        st.success(f"🎁 **今日のラッキーアクション**：{random.choice(mentor_data[selected_mentor]['actions'])}")

        # --- 診断結果のテキスト生成 ---
        report_text = f"""【MBTI性格診断クエスト 結果レポート】
実施日時: 2025-12-29
判定タイプ: {full_res}
動物タイプ: {detail['animal']}
キャッチフレーズ: {detail['catchphrase']}

■強み
{detail['strengths']}

■弱み
{detail['weaknesses']}

■仕事・スタンス
{detail['details']['work']}

■対人関係・愛
{detail['details']['love']}

■ストレス時の傾向
{detail['details']['stress']}

■最高の相性
{detail['details']['best_match']}

■今日のメンター（{selected_mentor}）からのメッセージ
「{msg}」
------------------------------------------
"""
        
        # 保存ボタンの設置
        st.download_button(
            label="📋 診断結果をテキストで保存する",
            data=report_text,
            file_name=f"MBTI_Result_{full_res}.txt",
            mime="text/plain",
            use_container_width=True
        )

        if st.button("🔄 最初からやり直す", use_container_width=True):
            st.session_state.clear()
            st.rerun()

if __name__ == "__main__":
    run_mbti_diagnostic()

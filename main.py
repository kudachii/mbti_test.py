import streamlit as st
import plotly.graph_objects as go
import random

def run_mbti_diagnostic():
    st.set_page_config(page_title="MBTI性格診断 Pro", page_icon="🧠", layout="wide")

    st.markdown('<h3 style="font-size: 26px; font-weight: bold; color: #4A90E2;">🧠 性格タイプ診断 Pro (超具体的アドバイス版)</h3>', unsafe_allow_html=True)
    st.caption("2025年12月23日 05:52：16タイプすべての解説を限界まで具体化しました。")

    # --- 1. 質問データ (24問) ---
    questions = [
        ("多人数で集まるイベントに参加すると元気が出る", "E-I", 1),
        ("自分の考えを整理するときは、誰かに話すより一人で考えたい", "E-I", -1),
        ("知らない人にも自分から話しかけるのは苦ではない", "E-I", 1),
        ("活動的な一日の後は、一人で静かに過ごす時間が必要だ", "E-I", -1),
        ("新しいアイデアより、すでに証明されているやり方を信頼する", "S-N", 1),
        ("空想より、現実的な問題解決に興味がある", "S-N", 1),
        ("物事の裏に隠された「意味」について考えるのが好きだ", "S-N", -1),
        ("詳細データより、インスピレーションを信じることが多い", "S-N", -1),
        ("決断を下す際、論理や効率を最も重視する", "T-F", 1),
        ("悩みを聞くとき、解決策を提示するよりまず気持ちに寄り添いたい", "T-F", -1),
        ("正論でも、誰かを傷つける可能性があるなら言葉を選ぶべきだ", "T-F", -1),
        ("誰かが間違っていたら、場の空気を壊してでも訂正すべきだと思う", "T-F", 1),
        ("やるべきことはリスト化して、一つずつ消していくのが好きだ", "J-P", 1),
        ("旅行に行くときは、予定を細かく決めずに動きたい", "J-P", -1),
        ("仕事や勉強は、締め切りギリギリにならないと本気が出ない", "J-P", -1),
        ("決まったルールやルーティンを守ることに安心感を覚える", "J-P", 1),
        ("注目を浴びる立場になることは、どちらかといえば好きだ", "E-I", 1),
        ("マニュアルがある場合、それを忠実に守る方だ", "S-N", 1),
        ("人から「共感力が高い」と言われるより「頭が良い」と言われたい", "T-F", 1),
        ("予期せぬトラブルにも臨機応変に対応することを楽しめる", "J-P", -1),
        ("ストレスを感じる状況でも、比較的冷静でいられる", "A-T", 1),
        ("過去の失敗をいつまでも悔やんでしまうことがある", "A-T", -1),
        ("自分の能力や決断に自信を持っている", "A-T", 1),
        ("他人の目が気になり、自分を過小評価してしまうことがある", "A-T", -1),
    ]

    # --- 2. メンターデータ (全6名) ---
    mentor_data = {
        "ギャル先生": {
            "quote": "「おはよー！あんたの魅力、マジでバズり確定じゃん！✨ その調子で今日もハピネスに、自分軸でブチ上げてこー！💖」",
            "actions": ["「コンビニの新作スイーツ買って自分にご褒美あげちゃお！✨」", "「鏡の前で『今日も可愛いじゃん』って言ってみて？💖」", "「派手な色の小物を1つ身につけてみて！🌈」"]
        },
        "頼れるお姉さん": {
            "quote": "「一生懸命なところ、素敵よ。でもたまには肩の力を抜いて、私に甘えていいのよ？」",
            "actions": ["「5分だけデジタルデトックスをして温かい飲み物を。心の充電が必要よ。」", "「寝る前に頑張ったことを3つ思い出して自分を褒めてあげてね。」", "「ゆっくりお風呂に浸かって、好きな香りの入浴剤を楽しんでみて。」"]
        },
        "カサネ・イズミ：論理と不確定要素": {
            "quote": "「あなたのデータは極めて特異だ。その思考を最適化すれば、さらなる高みへ到達できる。」",
            "actions": ["「デスクの上を完全に片付けろ。視覚的なノイズを排除しろ。」", "「今日学んだことを3行でメモしろ。知識の定着こそが力だ。」", "「タスクの優先順位を見直し、重要度の低いものを1つ捨てろ。」"]
        },
        "ツンデレな指導員": {
            "quote": "「ふん、あんたみたいなタイプは私が付いてないと危なっかしいわね。しっかりしなさいよ！」",
            "actions": ["「姿勢を正しなさい！背筋を伸ばしなさい！それだけで印象が変わるんだから。」", "「たまには自分を甘やかしなさいよね。ずっと頑張りすぎなのよ…心配してないわよ！」", "「今日は10分早く寝なさい。明日寝坊して困るのはあんたなんだからね！」"]
        },
        "論理的なビジネスコーチ": {
            "quote": "「あなたの能力を最大限に活かすための戦略を練ろう。まずは現状の分析からだ。」",
            "actions": ["「今日一番の重要課題を1つ決めて、それに集中しよう。」", "「明日のスケジュールを今夜のうちに10分で見直しておこう。」", "「身の回りのものを1つだけ新調してみよう。小さな変化が刺激になる。」"]
        },
        "優しさに溢れるメンター (Default)": {
            "quote": "「あなたは今のままで十分素晴らしいですよ。一緒に、一歩ずつ進んでいきましょうね。」",
            "actions": ["「深呼吸をゆっくり3回しましょう。」", "「大切な人に短い感謝のメッセージを送ってみませんか？」", "「散歩をしながら、空の色を眺めてみてください。」"]
        }
    }

    # --- 3. 性格タイプ詳細DB (全16タイプ・超具体版) ---
    mbti_db = {
        "ISTJ": {
            "name": "管理者",
            "strength": "・一度引き受けた仕事は、どんなに地味でも最後までやり遂げる「責任感の塊」。\n・複雑なルールや膨大なデータの中から、ミスを即座に見つけ出す精密さがある。\n・周囲がパニックになっても、過去の経験に基づいて冷静な判断を下せる。",
            "weakness": "・「マニュアルにないこと」が起きるとフリーズし、柔軟な対応に時間がかかる。\n・正論で相手を追い詰めすぎてしまい、周囲に「厳しい人」という印象を与える。\n・自分一人で抱え込みすぎて、キャパオーバーになってもSOSを出すのが苦手。",
            "mentor": "論理的なビジネスコーチ"
        },
        "ISFJ": {
            "name": "擁護者",
            "strength": "・他人のちょっとした表情の変化から「何かあった？」と察する、神がかった配慮ができる。\n・誕生日や以前話した些細なことを覚えていて、さりげないプレゼントや言葉で人を感動させる。\n・チームの潤滑油として、目立たないところで最高のサポート環境を整える。",
            "weakness": "・自分の意見を言うことで場が荒れるのを恐れ、常に「いい人」を演じて疲れ果てる。\n・感謝されないと「自分は必要ないのでは」と極端にネガティブになりやすい。\n・断ることができず、他人のタスクまで背負い込んで自分の時間がなくなる。",
            "mentor": "優しさに溢れるメンター (Default)"
        },
        "INFJ": {
            "name": "提唱者",
            "strength": "・言葉の裏にある「本当の意図」を見抜く洞察力があり、本質的なアドバイスができる。\n・「誰もが自分らしく生きられる世界」のような、高い理想を掲げて人を導くカリスマ性がある。\n・一人ひとりの心に深く寄り添い、相手が気づいていない才能を見つけ出すのが上手い。",
            "weakness": "・理想と現実のギャップに絶望し、突然「人間嫌いモード」に入って殻に閉じこもる。\n・完璧主義が自分に向くと、「自分はまだ何も成し遂げていない」と過剰に追い込む。\n・他人の悩みを自分のことのように感じてしまい、精神的な疲労が激しい。",
            "mentor": "頼れるお姉さん"
        },
        "INTJ": {
            "name": "建築家",
            "strength": "・10手先まで読むような戦略的思考ができ、効率の悪いシステムを劇的に改善できる。\n・周囲が感情的に議論している横で、事実だけを繋ぎ合わせて最短の解決策を提示する。\n・「自分ならできる」という圧倒的な自信を持ち、前例のない新しい分野を切り開ける。",
            "weakness": "・感情的な配慮を「非効率なコスト」と考え、冷徹な発言で人を傷つけても気づかない。\n・自分の理論が完璧だと思い込み、他人の意見を「論理的でない」と即座に切り捨てる。\n・プライドが高く、自分の弱みを見せることを極端に嫌い、孤立しやすい。",
            "mentor": "カサネ_イズミ：論理と不確定要素"
        },
        "ISTP": {
            "name": "巨匠",
            "strength": "・緊急事態でも「まあ、なんとかなるでしょ」と笑いながら手を動かし、即座に修理・解決する。\n・道具やITツールを使いこなすセンスが抜群で、最小限の努力で最大の成果を出す天才。\n・過干渉を嫌い、適度な距離感で人と付き合えるため、人間関係のトラブルが少ない。",
            "weakness": "・興味がないことに対しては驚くほど無関心で、周囲からは「何を考えているか謎」と思われる。\n・長期的な計画や単調な繰り返し作業が嫌いで、途中で投げ出してしまうことがある。\n・感情的な衝突を避けてその場から去るため、根本的な問題解決を先延ばしにしがち。",
            "mentor": "ツンデレな指導員"
        },
        "ISFP": {
            "name": "冒険家",
            "strength": "・独自の美的センスを持ち、服装やライフスタイルそのものが「一つの作品」のように魅力的。\n・偏見がなく、どんなに変わった人でも「それもいいじゃん」と受け入れる器の広さがある。\n・「今、この瞬間」を全力で楽しむ才能があり、周囲に穏やかな癒やしを与える。",
            "weakness": "・批判されると存在そのものを否定された気分になり、何日も引きずってしまう。\n・先の予定を立てるのが苦痛で、「その時の気分」で動くため約束を破ってしまうことがある。\n・自分の価値観が侵害されると、説明せずに突然関係を断つような極端な行動に出る。",
            "mentor": "ギャル先生"
        },
        "INFP": {
            "name": "仲介者",
            "strength": "・誰も気づかないような美しい景色や、心の微細な動きを言葉やアートで表現できる。\n・「自分だけの価値観」を大切にし、どんなに苦しくても自分の魂を売らない誠実さがある。\n・困っている人を見捨てられず、損を承知で助けにいく深い慈愛の心を持っている。",
            "weakness": "・現実世界の「お金」や「数字」の話に拒否反応を示し、実務的なことを放置しがち。\n・理想の世界に浸りすぎて、現実の自分とのギャップに苦しみ、自信を失いやすい。\n・一度傷つくとその経験を何度も反芻し、過去のトラウマから抜け出すのに時間がかかる。",
            "mentor": "頼れるお姉さん"
        },
        "INTP": {
            "name": "論理学者",
            "strength": "・「なぜ？」という好奇心が止まらず、誰も思いつかないような斬新なアイデアや理論を生む。\n・膨大な知識を頭の中で整理し、複雑な事象をシンプルに説明する抽象化能力が高い。\n・世間の常識を疑い、真理を追求するためなら孤独も厭わない強さがある。",
            "weakness": "・考えを巡らせるだけで満足してしまい、具体的に「実行」するのが極端に遅い。\n・身の回りの片付けや社会的なマナーを「些末なこと」として無視し、変人扱いされがち。\n・他人の感情的な悩みを論理で分析しようとして、「冷たい」と怒らせてしまう。",
            "mentor": "カサネ_イズミ：論理と不確定要素"
        },
        "ESTP": {
            "name": "起業家",
            "strength": "・圧倒的なエネルギーと社交性で、どんな環境でも即座に自分の居場所を作れる。\n・理屈より先に体が動くタイプで、まずはやってみてから軌道修正するスピード感が武器。\n・周囲を巻き込むカリスマ性があり、困難な目標も「面白そう！」と明るく突破する。",
            "weakness": "・スリルを求めすぎて、不必要なトラブルやリスクに首を突っ込み、周囲をハラハラさせる。\n・「今」が楽しければいいという考えが強く、貯金や健康、長期的な約束を疎かにしがち。\n・繊細な悩みを持つ人に対して「考えすぎだよ！」と一蹴してしまい、無神経だと思われる。",
            "mentor": "ツンデレな指導員"
        },
        "ESFP": {
            "name": "エンターテイナー",
            "strength": "・いるだけでその場がパッと明るくなる「歩く太陽」。人を笑わせる才能は天下一品。\n・実務的なセンスがあり、人々が喜ぶイベントの段取りや空間作りを直感的にこなせる。\n・流行に敏感で、常に新しいものを取り入れる好奇心と行動力がある。",
            "weakness": "・孤独を極端に嫌い、常に誰かと繋がっていないと不安で自分を見失ってしまう。\n・真面目な話や深刻な空気を避けて冗談で逃げようとし、不誠実だと思われることがある。\n・衝動買いや計画性のない行動で、経済的・時間的に自分を追い込んでしまう。",
            "mentor": "ギャル先生"
        },
        "ENFP": {
            "name": "広報運動家",
            "strength": "・「可能性」を見つける天才。人の隠れた才能を見抜き、本気で応援して開花させる。\n・どんなに初対面の人でも、一瞬で打ち解けて親友になれる圧倒的なコミュ力がある。\n・失敗しても「これも経験！」とポジティブに変換し、何度でも立ち上がれるレジリエンス。",
            "weakness": "・一度にたくさんのことに興味を持ちすぎて、結局どれも中途半端に終わってしまう。\n・「自分がどう見られているか」を実は深く気にしており、他人の些細な反応に一喜一憂する。\n・ルーティンワークや単純作業への耐性がゼロに等しく、やる気がなくなると極端にサボる。",
            "mentor": "ギャル先生"
        },
        "ENTP": {
            "name": "討論者",
            "strength": "・既存のルールや常識を疑い、屁理屈を最強の理論に変えて新しいスタンダードを作る。\n・圧倒的な語彙力と知識で、相手を説得（あるいは圧倒）し、交渉を有利に進める。\n・トラブルが起きるほどワクワクするタイプで、逆境での対応力が並外れている。",
            "weakness": "・相手の矛盾を突くのが楽しくて、つい論破してしまい、良好な人間関係を自ら壊す。\n・「口だけ」になりやすく、細かい実務や後のフォローを他人に丸投げしがち。\n・権威やルールに対して反抗的になりすぎて、組織の中で不要な摩擦を生みやすい。",
            "mentor": "ツンデレな指導員"
        },
        "ESTJ": {
            "name": "幹部",
            "strength": "・目標達成のために、誰に何をさせるべきか瞬時に判断し、組織を効率的に回す司令塔。\n・一度決めたルールや伝統を固く守り、揺るぎない安心感と秩序をチームに与える。\n・有言実行を地でいき、口先だけでなく背中で語るリーダーシップがある。",
            "weakness": "・自分のやり方が「唯一の正解」だと思い込み、異なる意見を感情的に否定してしまう。\n・効率ばかりを追求し、メンバーの疲労や感情的なフォローを「無駄」と切り捨てがち。\n・「こうあるべき」という固定観念が強く、予想外の柔軟な変化についていけない。",
            "mentor": "論理的なビジネスコーチ"
        },
        "ESFJ": {
            "name": "領事",
            "strength": "・周囲の誰が今困っているか、誰が不満を持っているかを完璧に把握し、調和を保つ。\n・地域のイベントや職場の飲み会など、人と人を繋ぐ場作りと気配りの天才。\n・自分よりも「みんなのため」を優先できる、誠実で温かい人柄で誰からも好かれる。",
            "weakness": "・周囲の評価が自分の価値のすべてになってしまい、人から嫌われるとパニックになる。\n・お節介がすぎて、相手が望んでいないアドバイスを押し付け、煙たがられることがある。\n・自分の常識から外れた行動をとる人を理解できず、陰で批判的な態度をとりやすい。",
            "mentor": "優しさに溢れるメンター (Default)"
        },
        "ENFJ": {
            "name": "主人公",
            "strength": "・他人の成長を自分以上に喜び、相手のポテンシャルを120%引き出す導き手。\n・理想の世界を熱く語ることで、冷めていた周囲の人の心に火をつけるカリスマ性がある。\n・感情と論理のバランスが良く、対立する二者の間に入って鮮やかに仲裁できる。",
            "weakness": "・他人の悩みや問題を自分のこととして背負い込み、自分自身のケアを完全に忘れてしまう。\n・嫌われることを恐れて、必要な場面でも厳しいことが言えず、問題の解決を遅らせる。\n・理想が高すぎるため、期待に応えてくれない人に対して密かに失望し、ストレスを溜める。",
            "mentor": "頼れるお姉さん"
        },
        "ENTJ": {
            "name": "指揮官",
            "strength": "・圧倒的な意志力と決断力で、どんなに困難なプロジェクトも力技で成功に導く。\n・常に「次の一手」を考え、ライバルが休んでいる間に圧倒的な差をつける努力家。\n・感情に左右されず、会社やチームにとって「何が最善か」を冷徹かつ客観的に判断できる。",
            "weakness": "・成果を出せない人に対して容赦なく切り捨て、周囲に「怖い」「冷酷だ」という恐怖心を与える。\n・他人のアドバイスを「時間の無駄」と感じやすく、独裁的な振る舞いになりがち。\n・プライベートの時間さえも仕事や自己研鑽に費やし、身近な家族や友人を疎かにしてしまう。",
            "mentor": "論理的なビジネスコーチ"
        }
    }

    # --- 4. 進捗管理 ---
    answered_count = 0
    for i in range(len(questions)):
        key = f"q_{i}"
        if key in st.session_state and st.session_state[key] is not None:
            answered_count += 1
    
    with st.sidebar:
        st.header("📊 診断の進捗")
        progress_per = answered_count / len(questions)
        st.progress(progress_per)
        st.write(f"**{answered_count} / {len(questions)} 問** 回答済み")
        st.divider()
        st.markdown("**ギャル先生からの応援**")
        if progress_per < 0.5: st.write("「まずは直感でポチポチいこー！✨」")
        elif progress_per < 1.0: st.write("「いい感じ！半分超えたよ、あと少し！🔥」")
        else: st.write("「完璧！あんたマジ最高！ボタン押しちゃいな！💖」")

    # --- 5. 質問表示 ---
    user_answers = {}
    for i, (q_text, axis, weight) in enumerate(questions):
        st.markdown(f"**Q{i+1}. {q_text}**")
        user_answers[i] = st.radio(f"radio_{i}", options=[1, 2, 3, 4, 5], 
                                   format_func=lambda x: {1: "全く違う", 2: "違う", 3: "中立", 4: "そう思う", 5: "強くそう思う"}[x],
                                   key=f"q_{i}", label_visibility="collapsed", horizontal=True, index=None)
        st.write("---")

    # --- 6. 診断実行 ---
    if st.button("診断結果を詳しく見る ✨", use_container_width=True):
        if answered_count < len(questions):
            st.error(f"まだ回答していない質問があるよ！（残り {len(questions) - answered_count} 問）")
        else:
            st.session_state["show_result"] = True

    if st.session_state.get("show_result"):
        st.balloons()
        scores = {"E-I": 0, "S-N": 0, "T-F": 0, "J-P": 0, "A-T": 0}
        for i, (q_text, axis, weight) in enumerate(questions):
            scores[axis] += (st.session_state[f"q_{i}"] - 3) * weight

        mbti_core = ("E" if scores["E-I"] >= 0 else "I") + ("S" if scores["S-N"] >= 0 else "N") + \
                    ("T" if scores["T-F"] >= 0 else "F") + ("J" if scores["J-P"] >= 0 else "P")
        identity = "-A" if scores["A-T"] >= 0 else "-T"
        full_res = mbti_core + identity

        detail = mbti_db.get(mbti_core)

        st.divider()
        st.markdown(f"## 判定結果：{full_res}（{detail['name']}）")

        # レーダーチャート
        categories = ['外向(E)', '感覚(S)', '思考(T)', '判断(J)', '自己主張(A)']
        values = [scores["E-I"], scores["S-N"], scores["T-F"], scores["J-P"], scores["A-T"]]
        fig = go.Figure(data=go.Scatterpolar(r=values + [values[0]], theta=categories + [categories[0]], fill='toself', line_color='#4A90E2', fillcolor='rgba(74, 144, 226, 0.3)'))
        fig.update_layout(polar=dict(radialaxis=dict(visible=True, range=[-12, 12])), showlegend=False)
        st.plotly_chart(fig, use_container_width=True)

        # 具体的解説セクション
        st.markdown("### 🔍 あなたの詳しい性格分析")
        col1, col2 = st.columns(2)
        with col1:
            st.info(f"✨ **ここがあなたの武器（強み）**\n\n{detail['strength']}")
        with col2:
            st.warning(f"⚠️ **ここに注意（気をつけたい点）**\n\n{detail['weakness']}")

        st.divider()

        # 🤝 メンター指名セクション
        st.markdown("### 🤝 今日のメンターを指名する")
        selected_mentor = st.selectbox(
            "指名されたメンターから、今のあなたにピッタリなアドバイスを贈ります。",
            options=list(mentor_data.keys()),
            index=list(mentor_data.keys()).index(detail["mentor"]) if detail["mentor"] in mentor_data else 5
        )

        m_info = mentor_data[selected_mentor]
        st.chat_message("assistant").write(f"**{selected_mentor}**：「{m_info['quote']}」")
        
        current_action = random.choice(m_info['actions'])
        st.success(f"🎁 **今日のラッキーアクション**：{current_action}")

        # --- 7. 保存機能 ---
        report_text = f"""【MBTI性格診断 Pro レポート】
日時: 2025年12月23日 05:52
判定結果: {full_res}（{detail['name']}）

■ あなたの強み
{detail['strength']}

■ 注意点
{detail['weakness']}

■ メンター: {selected_mentor}
■ ラッキーアクション: {current_action}
"""
        st.download_button(
            label="診断結果をダウンロードして保存 📥",
            data=report_text,
            file_name=f"MBTI_Result_{full_res}.txt",
            mime="text/plain",
            use_container_width=True
        )

if __name__ == "__main__":
    if "show_result" not in st.session_state:
        st.session_state["show_result"] = False
    run_mbti_diagnostic()

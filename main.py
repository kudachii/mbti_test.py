import streamlit as st
import plotly.graph_objects as go
import random

def run_mbti_diagnostic():
    st.set_page_config(page_title="MBTI性格診断 Pro", page_icon="🧠", layout="wide")

    st.markdown('<h3 style="font-size: 26px; font-weight: bold; color: #4A90E2;">🧠 性格タイプ診断 Pro (詳細解説版)</h3>', unsafe_allow_html=True)
    st.caption("2025年12月23日：あなたの特性をより具体的に分析し、実践的なアドバイスを届けます。")

    # 質問データ（全24問）
    questions = [
        ("多人数で集まるイベントに参加すると元気が出る", "E-I", 1),
        ("自分の考えを整理するときは、誰かに話すより一人で考えたい", "E-I", -1),
        ("知らない人にも自分から話しかけるのは苦ではない", "E-I", 1),
        ("活動的な一日の後は、一人で静かに過ごす時間が必要だ", "E-I", -1),
        ("新しいアイデアより、すでに証明されているやり方を信頼する", "S-N", 1),
        ("空想より、現実的な問題解決に興味がある", "S-N", 1),
        ("物事の裏に隠された「意味」について考えるのが好きだ", "S-N", -1),
        ("詳細データより、インスピレーションを信じることが多い", "S-N", -1),
        ("決断を下す際、論理や効率を最も重視する", "T-F", 1),
        ("悩みを聞くとき、解決策を提示するよりまず気持ちに寄り添いたい", "T-F", -1),
        ("正論でも、誰かを傷つける可能性があるなら言葉を選ぶべきだ", "T-F", -1),
        ("誰かが間違っていたら、場の空気を壊してでも訂正すべきだと思う", "T-F", 1),
        ("やるべきことはリスト化して、一つずつ消していくのが好きだ", "J-P", 1),
        ("旅行に行くときは、予定を細かく決めずに動きたい", "J-P", -1),
        ("仕事や勉強は、締め切りギリギリにならないと本気が出ない", "J-P", -1),
        ("決まったルールやルーティンを守ることに安心感を覚える", "J-P", 1),
        ("注目を浴びる立場になることは、どちらかといえば好きだ", "E-I", 1),
        ("マニュアルがある場合、それを忠実に守る方だ", "S-N", 1),
        ("人から「共感力が高い」と言われるより「頭が良い」と言われたい", "T-F", 1),
        ("予期せぬトラブルにも臨機応変に対応することを楽しめる", "J-P", -1),
        ("ストレスを感じる状況でも、比較的冷静でいられる", "A-T", 1),
        ("過去の失敗をいつまでも悔やんでしまうことがある", "A-T", -1),
        ("自分の能力や決断に自信を持っている", "A-T", 1),
        ("他人の目が気になり、自分を過小評価してしまうことがある", "A-T", -1),
    ]

    # --- 進捗管理 ---
    answered_count = 0
    for i in range(len(questions)):
        key = f"q_{i}"
        if key in st.session_state and st.session_state[key] is not None:
            answered_count += 1
    
    with st.sidebar:
        st.header("📊 診断の進捗")
        progress_per = answered_count / len(questions)
        st.progress(progress_per)
        st.write(f"**{answered_count} / {len(questions)} 問** 回答済み")
        st.divider()
        st.markdown("**ギャル先生からの応援**")
        if progress_per < 0.5: st.write("「まずは直感でポチポチいこー！✨」")
        elif progress_per < 1.0: st.write("「いい感じ！半分超えたよ、あと少し！🔥」")
        else: st.write("「完璧！あんたマジ最高！ボタン押しちゃいな！💖」")

    # --- 質問表示 ---
    user_answers = {}
    for i, (q_text, axis, weight) in enumerate(questions):
        st.markdown(f"**Q{i+1}. {q_text}**")
        user_answers[i] = st.radio(f"radio_{i}", options=[1, 2, 3, 4, 5], 
                                   format_func=lambda x: {1: "全く違う", 2: "違う", 3: "中立", 4: "そう思う", 5: "強くそう思う"}[x],
                                   key=f"q_{i}", label_visibility="collapsed", horizontal=True, index=None)
        st.write("---")

    if st.button("診断結果を詳しく見る ✨", use_container_width=True):
        if answered_count < len(questions):
            st.error(f"まだ回答していない質問があるよ！（残り {len(questions) - answered_count} 問）")
        else:
            st.balloons()
            scores = {"E-I": 0, "S-N": 0, "T-F": 0, "J-P": 0, "A-T": 0}
            for i, (q_text, axis, weight) in enumerate(questions):
                scores[axis] += (user_answers[i] - 3) * weight

            mbti_core = ("E" if scores["E-I"] >= 0 else "I") + ("S" if scores["S-N"] >= 0 else "N") + \
                        ("T" if scores["T-F"] >= 0 else "F") + ("J" if scores["J-P"] >= 0 else "P")
            identity = "-A" if scores["A-T"] >= 0 else "-T"
            full_res = mbti_core + identity

            # --- 具体的な性格詳細データ ---
            mbti_db = {
                "ISTJ": {
                    "name": "管理者",
                    "strength": "・事実に基づいた正確な仕事ができる\n・約束や締め切りを厳守し、周囲の信頼が厚い\n・秩序を重んじ、混沌とした状況を整理するのが得意",
                    "weakness": "・変化に対して慎重すぎて、チャンスを逃すことがある\n・正論を押し通しすぎて、他人の感情を無視しがち\n・自分にも他人にも厳しく、リラックスするのが苦手"
                },
                "ISFJ": {
                    "name": "擁護者",
                    "strength": "・他人のニーズに敏感で、きめ細やかなサポートができる\n・細部にまで注意が行き届き、丁寧な仕上げが得意\n・伝統やルールを大切にし、組織の安定に貢献する",
                    "weakness": "・他人の顔色を伺いすぎて、自分の本音を抑え込んでしまう\n・変化や対立を極端に恐れ、過度なストレスを抱えやすい\n・「ノー」と言えず、自分の許容量を超えた仕事を引き受けてしまう"
                },
                "INFJ": {
                    "name": "提唱者",
                    "strength": "・物事の本質や将来の可能性を見抜く直感力が鋭い\n・他人の感情に深く共感し、心の支えになれる\n・強い信念を持ち、より良い社会のために行動できる",
                    "weakness": "・理想が高すぎて、現実の不完全さに絶望しやすい\n・プライベートを隠しすぎるため、「ミステリアスすぎて近寄りがたい」と思われる\n・一人の時間がないと、精神的に燃え尽きてしまいやすい"
                },
                "INTJ": {
                    "name": "建築家",
                    "strength": "・極めて論理的で、複雑な問題を解決する戦略を立てられる\n・独立心が強く、周囲に流されずに自分の道を突き進める\n・知識欲が旺盛で、常に効率的なシステムを追求する",
                    "weakness": "・感情的な配慮を無駄だと感じ、冷酷だと思われることがある\n・自分の考えが正解だと信じ込み、他人の意見を聞き入れない\n・細かな実務作業や、変化のないルーティンワークを軽視しがち"
                },
                "ISTP": {
                    "name": "巨匠",
                    "strength": "・危機的状況でも冷静で、即座に現実的な対処ができる\n・道具や機械の扱いが器用で、実技に強い\n・無駄な議論を嫌い、最小限の力で最大の成果を出す",
                    "weakness": "・何の前触れもなく予測不能な行動をとり、周囲を困惑させる\n・感情表現が苦手で、親しい人とも距離を置いてしまう\n・長期的な計画を立てるのが苦手で、その場しのぎになりやすい"
                },
                "ISFP": {
                    "name": "冒険家",
                    "strength": "・独自の美的センスを持ち、芸術やデザインで才能を発揮する\n・偏見がなく寛容で、ありのままの他人を受け入れられる\n・「今この瞬間」を楽しみ、柔軟に状況に適応できる",
                    "weakness": "・批判されるとひどく落ち込み、何日も引きずってしまう\n・競争や争いを避けようとして、必要な主張を諦めてしまう\n・未来の予測や論理的な議論を苦痛に感じやすい"
                },
                "INFP": {
                    "name": "仲介者",
                    "strength": "・自分だけの強い価値観を持ち、誠実に生きようとする\n・独創的なアイデアや物語を生み出す才能がある\n・心優しく、少数派や困っている人に寄り添える",
                    "weakness": "・現実逃避をしがちで、実務的なタスクを放置してしまう\n・自分を責める傾向が強く、自信をなくしやすい\n・自分の価値観が侵害されると、突然頑固になり心を閉ざす"
                },
                "INTP": {
                    "name": "論理学者",
                    "strength": "・既存の枠組みに囚われない、自由で斬新な思考ができる\n・知的好奇心が無限で、真理を追求するためなら努力を惜しまない\n・他人の感情に左右されず、常に客観的な分析ができる",
                    "weakness": "・考えすぎて行動に移せず、未完成のプロジェクトを量産しがち\n・他人の何気ない一言を論破してしまい、場の空気を凍らせる\n・身の回りの片付けや社会的なマナーに全く無頓着になりやすい"
                },
                "ESTP": {
                    "name": "起業家",
                    "strength": "・抜群の行動力で、チャンスが来たら即座に飛び込める\n・社交的でカリスマ性があり、場を盛り上げるのが得意\n・現実を鋭く観察し、目に見える成果を素早く出せる",
                    "weakness": "・刺激を求めすぎて、危険なギャンブルや不必要な衝突に走る\n・長期的な結果を考えず、一時の感情で動いてしまう\n・ルールや規律を窮屈に感じ、勝手な行動で組織を乱すことがある"
                },
                "ESFP": {
                    "name": "エンターテイナー",
                    "strength": "・周囲を元気にする太陽のような明るさを持っている\n・実務的なセンスがあり、人々が喜ぶイベントを企画できる\n・他人に対して非常にオープンで、誰とでもすぐに仲良くなれる",
                    "weakness": "・複雑な理論や真面目な話を退屈に感じ、避けてしまう\n・目の前の楽しさを優先しすぎて、将来への備えを忘れる\n・人からの評価に敏感で、無視されると極端に不安になる"
                },
                "ENFP": {
                    "name": "広報運動家",
                    "strength": "・他人の隠れた才能を見つけ、やる気を引き出すのが上手い\n・コミュニケーション能力が非常に高く、人脈を広げる天才\n・新しい可能性にワクワクし、常に変化を楽しみ続けられる",
                    "weakness": "・細かい事務作業が極端に苦手で、書類ミスや忘れ物が多い\n・感情の起伏が激しく、やる気のムラがパフォーマンスに影響する\n・一つのことを最後までやり遂げる前に、次のことに手を出してしまう"
                },
                "ENTP": {
                    "name": "討論者",
                    "strength": "・どんな困難な状況でも、裏技や代替案を思いつける\n・弁が立ち、難しいコンセプトを分かりやすく説明できる\n・失敗を恐れず、常に新しいことに挑戦するエネルギーがある",
                    "weakness": "・相手を言い負かすことに集中し、人間関係を壊してしまう\n・細かい手順を守るのを嫌い、実務的な詳細を他人に押し付けがち\n・興味が次々と移るため、専門性を深めるのが難しい"
                },
                "ESTJ": {
                    "name": "幹部",
                    "strength": "・目標達成のために、人々を組織し効率的に動かす力がある\n・伝統や規律を守り、揺るぎないコミュニティを作り上げる\n・言行一致を重んじ、一度決めたことは最後までやり遂げる",
                    "weakness": "・自分のやり方が「唯一の正解」だと思い、柔軟性を欠く\n・成果が出ない人に対して批判的になり、威圧感を与えがち\n・感情的な配慮や、新しい試みを「無駄」だと切り捨ててしまう"
                },
                "ESFJ": {
                    "name": "領事",
                    "strength": "・周囲の調和を保つための配慮を欠かさず、チームをまとめる\n・実務的な管理能力が高く、日常のルーティンを確実にこなす\n・他人の幸せを自分のことのように喜べる、温かい心の持ち主",
                    "weakness": "・自分の価値観と違う人を受け入れるのが難しく、批判的になる\n・感謝されないとひどく落ち込み、恩着せがましい態度をとってしまう\n・社会的な地位や世間体を気にしすぎて、自分を見失うことがある"
                },
                "ENFJ": {
                    "name": "主人公",
                    "strength": "・他人を鼓舞し、共通の目標に向かって導くカリスマ性がある\n・相手の良さを引き出し、成長をサポートするのが得意\n・言葉に説得力があり、対立する人々の仲裁ができる",
                    "weakness": "・他人の問題に深く首を突っ込みすぎて、自分まで疲れ果てる\n・嫌われることを恐れ、重要な決断を先延ばしにしてしまう\n・理想を追いすぎるあまり、現実的な制約や予算を無視しがち"
                },
                "ENTJ": {
                    "name": "指揮官",
                    "strength": "・圧倒的なリーダーシップで、大規模なプロジェクトを成功させる\n・非効率なシステムを瞬時に見抜き、大胆に改善できる\n・自信に溢れ、未知の領域にも怯まずに進んでいける",
                    "weakness": "・他人の感情や弱さを理解できず、傲慢な態度をとることがある\n・目的のためには手段を選ばず、周囲を強引に引きずり回す\n・「今」の小さな幸せを犠牲にし、常に未来の成功ばかり追いかける"
                }
            }

            # メンター名紐付け
            mentor_map = {
                "ISTJ": "論理的なビジネスコーチ", "ISFJ": "優しさに溢れるメンター (Default)", "INFJ": "頼れるお姉さん",
                "INTJ": "カサネ・イズミ：論理と不確定要素", "ISTP": "ツンデレな指導員", "ISFP": "ギャル先生",
                "INFP": "頼れるお姉さん", "INTP": "カサネ・イズミ：論理と不確定要素", "ESTP": "ツンデレな指導員",
                "ESFP": "ギャル先生", "ENFP": "ギャル先生", "ENTP": "ツンデレな指導員",
                "ESTJ": "論理的なビジネスコーチ", "ESFJ": "優しさに溢れるメンター (Default)",
                "ENFJ": "頼れるお姉さん", "ENTJ": "論理的なビジネスコーチ"
            }

            detail = mbti_db.get(mbti_core)
            mentor_name = mentor_map.get(mbti_core)

            # --- 結果表示 ---
            st.divider()
            st.markdown(f"## 判定結果：{full_res}（{detail['name']}）")

            # チャート表示
            categories = ['外向(E)', '感覚(S)', '思考(T)', '判断(J)', '自己主張(A)']
            values = [scores["E-I"], scores["S-N"], scores["T-F"], scores["J-P"], scores["A-T"]]
            fig = go.Figure(data=go.Scatterpolar(r=values + [values[0]], theta=categories + [categories[0]], fill='toself', line_color='#4A90E2', fillcolor='rgba(74, 144, 226, 0.3)'))
            fig.update_layout(polar=dict(radialaxis=dict(visible=True, range=[-12, 12])), showlegend=False)
            st.plotly_chart(fig, use_container_width=True)

            # 具体的解説セクション
            st.markdown("### 🔍 あなたの詳しい性格分析")
            col1, col2 = st.columns(2)
            with col1:
                st.info(f"✨ **ここがあなたの武器（強み）**\n\n{detail['strength']}")
            with col2:
                st.warning(f"⚠️ **ここに注意（気をつけたい点）**\n\n{detail['weakness']}")

            # ラッキーアクション
            lucky_actions = {
                "ギャル先生": ["「今日はコンビニの新作スイーツ買って自分にご褒美あげちゃお！✨」", "「鏡の前で『今日も可愛いじゃん』って言ってみて？💖」", "「派手な色の小物を1つ身につけてみて！テンション上がるよ！🌈」"],
                "頼れるお姉さん": ["「5分だけデジタルデトックスをして温かい飲み物を。心の充電が必要よ。」", "「寝る前に頑張ったことを3つ思い出して自分を褒めてあげてね。」", "「ゆっくりお風呂に浸かって、好きな香りの入浴剤を楽しんでみて。」"],
                "カサネ・イズミ：論理と不確定要素": ["「デスクの上を完全に片付けろ。視覚的なノイズを排除しろ。」", "「今日学んだことを3行でメモしろ。知識の定着こそが力だ。」", "「タスクの優先順位を見直し、重要度の低いものを1つ捨てろ。」"],
                "ツンデレな指導員": ["「ほら、姿勢が悪いわよ！背筋を伸ばしなさい！それだけで印象が変わるんだから。」", "「たまには自分を甘やかしなさいよね。ずっと頑張りすぎなのよ…心配してないわよ！」", "「今日は10分早く寝なさい。明日寝坊して困るのはあんたなんだからね！」"],
                "論理的なビジネスコーチ": ["「今日一番の重要課題を1つ決めて、それに集中しよう。」", "「明日のスケジュールを今夜のうちに10分で見直しておこう。」", "「身の回りのものを1つだけ新調してみよう。小さな変化が刺激になる。」"],
                "優しさに溢れるメンター (Default)": ["「深呼吸をゆっくり3回しましょう。」", "「大切な人に短い感謝のメッセージを送ってみませんか？」", "「散歩をしながら、空の色を眺めてみてください。」"]
            }
            action = random.choice(lucky_actions.get(mentor_name, ["今日は自分を大切に過ごしましょう。"]))
            st.success(f"📌 **{mentor_name} からのラッキーアクション**\n\n**{action}**")

if __name__ == "__main__":
    run_mbti_diagnostic()
